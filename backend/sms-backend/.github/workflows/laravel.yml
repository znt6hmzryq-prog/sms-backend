defaults:
  run:
    shell: bash -l {0}
    working-directory: backend/sms-backend

steps:
  - name: Checkout repository
    uses: actions/checkout@v4
    with:
      fetch-depth: 1
      submodules: false

  - name: Deinit/remove broken submodules (safe)
    working-directory: .
    run: |
      git submodule deinit --all || true
      [ -f .gitmodules ] && sed -n 's/^/FOUND .gitmodules: /;p' .gitmodules || true
      rm -f .gitmodules || true
      git rm -rf --cached Elham-Mukhtari || true
      rm -rf Elham-Mukhtari || true

  - name: Setup PHP
    uses: shivammathur/setup-php@v4
    with:
      php-version: ${{ matrix.php }}
      extensions: mbstring, bcmath, pdo, pdo_sqlite
      ini-values: post_max_size=256M, memory_limit=2G
      tools: composer:2

  - name: Cache composer
    uses: actions/cache@v4
    with:
      path: ~/.composer/cache
      key: ${{ runner.os }}-composer-${{ hashFiles('backend/sms-backend/composer.lock') }}
      restore-keys: ${{ runner.os }}-composer-

  - name: Diagnostics (project dir)
    run: |
      echo "--- RUN CONTEXT ---"
      echo "PWD: $(pwd)"
      echo "List project dir:"
      ls -la || true
      echo "Composer version (if available):"
      composer --version || true
      if [ -f  ]; then head -n 200  || true; else echo "composer.json missing"; fi
      composer diagnose || true

  - name: Ensure project .env exists (safe)
    run: |
      if [ -f .env ]; then
        echo ".env already exists"
      elif [ -f  ]; then
        cp  .env
      else
        cat > .env <<'EOF'
          - name: Install dependencies
    run: composer install --no-interaction --prefer-dist --no-scripts --no-progress --verbose

  - name: Prepare environment and sqlite DB
    env:
      APP_ENV: testing
      DB_CONNECTION: sqlite
      DB_DATABASE: 
    run: |
      mkdir -p database
      touch 
      php artisan key:generate --ansi --force
      php artisan migrate --force

  - name: Run test suite
    run: php artisan test --no-interaction